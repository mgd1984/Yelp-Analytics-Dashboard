---
title: "Yelp Toronto"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
storyboard: true
vertical_layout: fill 
social: menu
source_code: embed
theme: readable
runtime: shiny

---

<style>                     
.navbar {
  background-color:#c41200;
  border-color:black;
}
.navbar-brand {
color:black!important;
}

</style> 

```{r setup, include=FALSE}
library(flexdashboard)
library(DT)
library(shiny)
library(dplyr)
library(leaflet)
library(leaflet.extras)
library(highcharter)
library(stringr)
library(data.table)

load("yelp_data.Rdata")
x <- "Toronto"
yelp_city <- filter(yelp_biz_df, city == "Toronto")

```

```{r Define Parse_Drilldown & Parse_Multi_Series Helper Functions}
#-- parse_drilldown() -------------------------------------
# Prepares the data into separate lists for top level columns
# and drilldowns.
# Parameters:
#   data............Data frame
#   toplevel........Column name to use for the toplevel categories
#   drilldown.......Column name to use for the drilldown categories
#   type............Type of chart for drilldown series
#   summarise.......Column name to sum on for toplevel and drilldowns
#   fn..............Function to aggregate the summarise variable by 
#                   at the top level. 
#   drilldownId.....Optional function to add an id to the drilldowns
#   ... ............Parameters passed to the function fn
# Returns:
#   list with top level and drill down lists. 
#----------------------------------------------------------
parse_drilldown <- function(data, toplevel, drilldown, type, summarise, fn, drilldownId = '', ...){
  data <- setDT(data)
  
  data <- setcolorder(data, c(toplevel, drilldown, summarise))
  names(data) <- c("top", "drill", "what")
  
  top <- data[, .(what = fn(what, ...)), by = top]
  top <- mapply(function(x, y, z){
    list(
      name = x,
      y = as.numeric(y),
      drilldown = str_replace_all(paste0(drilldownId, summarise, "_drill_", x), "\\s+", "_")
    )
  }, top$top, top$what, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  
  drill <- data[, .(what = list(list(what = what, drill = drill))), by = top]
  
  drill <- mapply(function(x, y){
    list(
      type = type,
      name = paste0(drilldownId, summarise, ' ', x),
      id = str_replace_all(paste0(drilldownId, summarise, "_drill_", x), "\\s+", "_"),
      data = mapply(function(x, y, z){
        list(
          name = x,
          y = y
        )
      }, y[[2]], y[[1]], SIMPLIFY = FALSE, USE.NAMES = FALSE)
    )
  }, drill$top, drill$what, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  
  return(list(top = top, drill = drill))
}

#-- pares_multi_series() ----------------------------------
# Prepares the data into a list of data series for a multi-series
# chart. 
# Parametrs:
#   data............Data containing the different series
#   categories......Column name to use as the categories
# Returns:
#   list of data series.
#----------------------------------------------------------
parse_multi_series <- function(data, categories){
  series <- lapply(data[, !c(categories), with=FALSE], function(y, x){
    mapply(function(x, y){
      list(
        name = x,
        y = y
      )
    }, x, y, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  }, data[[categories]])
}
```

Dashboard Home {data-navmenu="Dashbaord Home"}
==================================
Column {data-width=200}
-------------------------------------

### About this dashboard
<div style = "text align: center">
<center>![](https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/Yelp_Logo.svg/1200px-Yelp_Logo.svg.png) 
</center>
</div>

<div style = "padding: 30px">
This dashboard allows you to explore trends and various other KPI in Yelp's data sets. The metro area covered is depicted in the included map. We picked Toronto to focus on. Explore the different data visualizations using the tabs above.  


**Our purpose**
To connect people with great local businesses<br>

**10 Facts About Yelp** <br>
1. Yelp was founded in 2004 to help people find great local businesses like dentists, hair stylists and mechanics.<br>
2. Yelp had a monthly average of 26 million unique visitors who visited Yelp via the Yelp app and 73 million unique visitors who visited Yelp via mobile web in Q1 2017.<br>
3. Yelpers have written more than 127 million reviews by the end of Q1 2017<br>
4. In addition to reviews, you can use Yelp to find events, lists and to talk with other Yelpers.<br>
5. Every business owner (or manager) can setup a free account to post photos and message their customers.<br>
6. Yelp makes money by selling ads to local businesses - youâ€™ll see these clearly labeled "Yelp Ads" around the site.<br>
7. Paying advertisers can never change or re-order their reviews.<br>
8. Yelp uses automated software to recommend the most helpful and reliable reviews for the Yelp community among the millions we get. The software looks at dozens of different signals, including various measures of quality, reliability, and activity on Yelp. The process has nothing to do with whether a business advertises on Yelp or not.<br>
9. You can access Yelp via iPhone, Android, and more - see the full list of mobile apps here.<br>
10. The Local Yelp brings locals updates on the latest and greatest business openings & other happenings.
</div>

Map
===================================== 

Row
-----------------------------------------------------------------------

### Average Number of Stars
```{r}

av_num_stars <- round(mean(yelp_city$stars),1)

valueBox(av_num_stars, 
         icon = "fa-star",
         color = "#e07070")
```

### Number of Restaurants 

```{r}
num_restaurants <- nrow(yelp_city)

valueBox(format(num_restaurants, big.mark = ","), 
         icon = "ion-fork",
         color = "#e07070")
```

### Numer of Yelp Reviews

```{r}
sum_of_reviews <- sum(yelp_city$review_count)

valueBox(format(sum_of_reviews, big.mark = ","),
         icon = "fa-yelp",
         color = "#e07070")
```

Row 
-----------------------------------------------------------------------

### Map of Toronto

```{r}
leafletOutput('restaurant_map')

output$restaurant_map <- renderLeaflet({
  if (input$restaurants == 1){
      selected_rank <- yelp_city
      
  } else if (input$restaurants == 2){
    
    selected_rank <-arrange(yelp_city, desc(review_count/stars)) %>%
      head(10)
    
  }  else {
  
  selected_rank <- arrange(yelp_city, desc(review_count/stars)) %>%
    tail(10)
  }
  
  leafIcons <- icons(
  iconUrl = ifelse(yelp_city$stars > 3.5,
    "https://image.flaticon.com/icons/png/128/160/160204.png",
    "https://image.flaticon.com/icons/png/128/408/408727.png"
  ),
  iconWidth =35, iconHeight = 35,
)
  
  standard_map_style <- "https://api.mapbox.com/styles/v1/mgd1984/cj4zsakdt0ztm2smwbnzr56a7/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWdkMTk4NCIsImEiOiJjajMwNmlscHQwMDIyMnFvMzdrZ2tocWJpIn0.beIkvfwLITKLQDDbi1ZjGA"
  
    yelp_map <- leaflet(data = selected_rank) %>%
      setView(lng =-79.4391695 , lat=43.7356082, zoom=11) %>% 
      addTiles("https://api.mapbox.com/styles/v1/mgd1984/cj5hh4lzf462u2sob1kwsn2vv/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWdkMTk4NCIsImEiOiJjajMwNmlscHQwMDIyMnFvMzdrZ2tocWJpIn0.beIkvfwLITKLQDDbi1ZjGA",group="Standard") %>% 
      addProviderTiles(providers$Thunderforest.TransportDark,group="Dark") %>% 
      addProviderTiles(providers$Esri.WorldImagery, group = "Satellite") %>%
      addProviderTiles(providers$Thunderforest.OpenCycleMap, group = "Light") %>%
      addMarkers(~longitude, ~latitude, popup = ~as.character(paste("Name:",name,"<br>", "Reviews:",review_count)),clusterOptions = markerClusterOptions(),icon = leafIcons) %>% 
      addHeatmap(~longitude, ~latitude, intensity = NULL,blur = 40,group="Heatmap") %>%
      addLayersControl(
        baseGroups = c("Standard","Dark","Satellite","Light"),
        overlayGroups = c("Heatmap"),
        options = layersControlOptions(collapsed = F)) %>% 
      hideGroup("Heatmap")
})

```

Column {.sidebar}
-----------------------------------------------------------------------
### Restaurants
```{r}

#Filter for Top 10 and Bottom 10 restaurants in TORONTO
all_restaurants_and_stars <- yelp_city %>%
  select(c(name, stars))

rest_stars_desc <- arrange(all_restaurants_and_stars,desc(stars))

#TOP
top_10_restaurants <- rest_stars_desc %>%
  head(10)

top_10_restaurants <- top_10_restaurants %>%
  select(name)

#BOTTOM
bottom_10_restaurants <- rest_stars_desc %>%
  tail(10)

bottom_10_restaurants <- bottom_10_restaurants %>%
  select(name)

neighborhoods <- yelp_city %>%
filter(!is.na(neighborhood)) %>%
  group_by(neighborhood) %>%
  summarise(total = sum(review_count)) %>%
  arrange(desc(total)) %>%
  head(10)

inputPanel(
 selectInput('restaurants', label = "Select Restaurants", choices=list(`All Restaurants` = 1, `Top 10 Restaurant` = 2, `Bottom 10 Restaurants` = 3))
)

inputPanel(
  selectInput('restaurants', label = "Select Neighbourhood", choices = as.list(neighborhoods$neighborhood)
          )
        )

```

KPI's
=====

Column {.sidebar}
---

Row
---

Sentiment Analysis 
===

Column {.sidebar}
---

Row
---